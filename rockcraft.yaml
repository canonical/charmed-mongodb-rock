# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.
name: mongodb # the name of your ROCK
base: ubuntu:22.04 # the base environment for this ROCK
version: '5.0' # just for humans. Semantic versioning is recommended
summary: MongoDB in a rock. # 79 char long summary
description: |
    MongoDB is a source-available cross-platform
    document-oriented database program. Classified
    as a NoSQL database program, MongoDB uses JSON
    -like documents with optional schemas.
license: Apache-2.0 # your application's SPDX license
cmd:
    - /usr/bin/setpriv
    - --clear-groups
    - --reuid
    - mongodb
    - --regid
    - mongodb
    - --
    - /usr/bin/mongod
platforms: # The platforms this ROCK should be built on and run on
    amd64:

parts:
    mongo-snap:
        plugin: nil
        stage-snaps:
            - charmed-mongodb/5.0/edge
        override-prime: |
            craftctl default
            export SNAP=$CRAFT_STAGE
            export SNAP_COMMON=$CRAFT_PRIME/var/snap/charmed-mongodb/common
            export SNAP_DATA=$CRAFT_PRIME/var/snap/charmed-mongodb/current
            mkdir -p $SNAP_COMMON
            mkdir -p $SNAP_DATA
            $CRAFT_PRIME/snap.charmed-mongodb/hooks/install
    dep-debs:
        plugin: nil
        stage-packages:
            - util-linux
    non-root-user:
        plugin: nil
        after: [mongo-snap]
        overlay-script: |
            # Create a user in the $CRAFT_OVERLAY chroot
            groupadd -R $CRAFT_OVERLAY -g 1000 mongodb
            useradd -R $CRAFT_OVERLAY -M -r -g mongodb -u 1000 mongodb
